import 'dart:convert';
import 'package:sqflite/sqflite.dart';
import 'package:path/path.dart';

class DBHelper {
  static final DBHelper instance = DBHelper._init();
  static Database? _database;

  DBHelper._init();

  Future<Database> get database async {
    if (_database != null) return _database!;
    _database = await _initDB('batasku_app.db');
    return _database!;
  }

  Future<Database> _initDB(String filePath) async {
    final dbPath = await getDatabasesPath();
    final path = join(dbPath, filePath);

    // ------------------ HAPUS DATABASE LAMA ------------------
    await deleteDatabase(path);

    // ------------------ BUKA / BUAT DATABASE BARU ------------------
    return await openDatabase(path, version: 2, onCreate: _createDB);
  }

  Future _createDB(Database db, int version) async {
    // ------------------ USERS TABLE ------------------
    await db.execute('''
      CREATE TABLE users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT NOT NULL,
        password TEXT NOT NULL
      )
    ''');
    await db.insert('users', {"username": "admin", "password": "123456"});

    // ------------------ REGIONS TABLE ------------------
    await db.execute('''
      CREATE TABLE regions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        polygon TEXT NOT NULL
      )
    ''');

    // ------------------ SEED DATA: ACEH BARAT ------------------
    List<List<double>> acehBaratPolygon = [
      [96.0691, 4.1954],
      [96.0554, 4.2052],
      [96.0427, 4.2089],
      [96.036, 4.2058],
      [96.033, 4.2022],
      [96.0325, 4.1975],
      [96.0298, 4.1981],
      [96.0261, 4.1942],
      [96.0238, 4.1948],
      [96.0222, 4.1979],
      [96.0222, 4.2053],
      [96.0131, 4.2181],
      [95.9862, 4.2475],
      [95.9683, 4.2644],
      [95.9057, 4.3376],
      [95.8767, 4.3675],
      [95.8802, 4.3724],
      [95.8901, 4.3795],
      [95.9121, 4.411],
      [95.9164, 4.4193],
      [95.9189, 4.4328],
      [95.9278, 4.4447],
      [95.9391, 4.4739],
      [95.9537, 4.5033],
      [95.9648, 4.5177],
      [95.9885, 4.5363],
      [96.0, 4.5392],
      [96.0057, 4.5462],
      [96.0249, 4.5608],
      [96.0279, 4.5625],
      [96.0367, 4.5624],
      [96.047, 4.5668],
      [96.0467, 4.5798],
      [96.0479, 4.5832],
      [96.0506, 4.5837],
      [96.0511, 4.5909],
      [96.0463, 4.5973],
      [96.0374, 4.6009],
      [96.0277, 4.6165],
      [96.0325, 4.6281],
      [96.0337, 4.6422],
      [96.0423, 4.6575],
      [96.0749, 4.6778],
      [96.0915, 4.6965],
      [96.0998, 4.7101],
      [96.1064, 4.7295],
      [96.1169, 4.7397],
      [96.1183, 4.7479],
      [96.1146, 4.7606],
      [96.1171, 4.7674],
      [96.1219, 4.7674],
      [96.1344, 4.7575],
      [96.1431, 4.7545],
      [96.1505, 4.7552],
      [96.1681, 4.7647],
      [96.1796, 4.7675],
      [96.1862, 4.7675],
      [96.2038, 4.7612],
      [96.2192, 4.7634],
      [96.2259, 4.7653],
      [96.2358, 4.7775],
      [96.2415, 4.7813],
      [96.255, 4.7873],
      [96.2665, 4.7954],
      [96.2746, 4.7969],
      [96.2763, 4.795],
      [96.2807, 4.779],
      [96.2705, 4.7746],
      [96.269, 4.7718],
      [96.268, 4.7506],
      [96.2644, 4.7425],
      [96.2647, 4.7373],
      [96.2603, 4.7135],
      [96.2623, 4.7106],
      [96.2709, 4.7082],
      [96.2749, 4.7051],
      [96.2806, 4.6936],
      [96.3151, 4.6875],
      [96.3433, 4.69],
      [96.3601, 4.6866],
      [96.3694, 4.6917],
      [96.3948, 4.6797],
      [96.4087, 4.6692],
      [96.4241, 4.6491],
      [96.438, 4.6395],
      [96.4444, 4.6267],
      [96.4477, 4.6253],
      [96.4607, 4.6255],
      [96.4677, 4.6266],
      [96.4731, 4.63],
      [96.4861, 4.6305],
      [96.4899, 4.6252],
      [96.4925, 4.6189],
      [96.4945, 4.6033],
      [96.4942, 4.5987],
      [96.4916, 4.5949],
      [96.4937, 4.5731],
      [96.492, 4.5552],
      [96.4875, 4.5512],
      [96.4631, 4.5454],
      [96.4587, 4.5328],
      [96.4509, 4.5224],
      [96.4444, 4.517],
      [96.4404, 4.51],
      [96.4478, 4.4958],
      [96.4744, 4.4687],
      [96.4796, 4.461],
      [96.4797, 4.4583],
      [96.4533, 4.4333],
      [96.4415, 4.4258],
      [96.4218, 4.4214],
      [96.3835, 4.4201],
      [96.372, 4.4174],
      [96.3707, 4.4128],
      [96.3736, 4.4103],
      [96.3708, 4.3991],
      [96.3732, 4.3965],
      [96.3717, 4.3928],
      [96.3691, 4.3918],
      [96.3673, 4.3929],
      [96.3662, 4.3906],
      [96.3586, 4.3868],
      [96.358, 4.3818],
      [96.3415, 4.38],
      [96.3411, 4.3762],
      [96.3385, 4.376],
      [96.3389, 4.3745],
      [96.3357, 4.3708],
      [96.3291, 4.3671],
      [96.3228, 4.3685],
      [96.3203, 4.3678],
      [96.3197, 4.3647],
      [96.318, 4.3644],
      [96.3138, 4.3682],
      [96.3078, 4.3676],
      [96.3016, 4.3702],
      [96.296, 4.3683],
      [96.2969, 4.3505],
      [96.2908, 4.3242],
      [96.2859, 4.2893],
      [96.282, 4.2859],
      [96.2861, 4.2696],
      [96.282, 4.2657],
      [96.2807, 4.2538],
      [96.2704, 4.244],
      [96.2665, 4.2272],
      [96.2682, 4.2173],
      [96.2709, 4.2149],
      [96.2751, 4.2143],
      [96.2769, 4.2105],
      [96.2724, 4.1966],
      [96.2777, 4.1835],
      [96.2746, 4.1744],
      [96.2772, 4.1686],
      [96.2749, 4.1659],
      [96.2764, 4.1581],
      [96.279, 4.1556],
      [96.2731, 4.1507],
      [96.2734, 4.1479],
      [96.2676, 4.146],
      [96.2626, 4.138],
      [96.2466, 4.1261],
      [96.2248, 4.117],
      [96.2142, 4.1178],
      [96.2065, 4.1158],
      [96.1919, 4.1072],
      [96.1548, 4.1376],
      [96.1476, 4.141],
      [96.1424, 4.1423],
      [96.1344, 4.1407],
      [96.1306, 4.1367],
      [96.1305, 4.1348],
      [96.1332, 4.1319],
      [96.1299, 4.1305],
      [96.1287, 4.1252],
      [96.1265, 4.1245],
      [96.1264, 4.1322],
      [96.1228, 4.1384],
      [96.0691, 4.1954],
    ];

    await db.insert("regions", {
      "name": "Aceh Barat",
      "polygon": jsonEncode(acehBaratPolygon),
    });

    List<List<double>> acehBaratDayaPolygon = [
      [96.942, 3.5746],
      [96.9343, 3.5782],
      [96.9105, 3.5976],
      [96.9033, 3.6016],
      [96.9019, 3.601],
      [96.9023, 3.6059],
      [96.8947, 3.6204],
      [96.897, 3.6259],
      [96.8942, 3.6439],
      [96.8837, 3.6693],
      [96.8722, 3.6863],
      [96.8566, 3.6996],
      [96.8439, 3.705],
      [96.8345, 3.707],
      [96.8191, 3.7164],
      [96.8119, 3.7172],
      [96.8108, 3.722],
      [96.8079, 3.7251],
      [96.7935, 3.7245],
      [96.7836, 3.7337],
      [96.7749, 3.7387],
      [96.7529, 3.7396],
      [96.744, 3.7441],
      [96.7375, 3.7435],
      [96.7244, 3.7471],
      [96.6978, 3.7431],
      [96.6689, 3.7473],
      [96.641, 3.7451],
      [96.6303, 3.7423],
      [96.6168, 3.7363],
      [96.619, 3.747],
      [96.6143, 3.7535],
      [96.6176, 3.7571],
      [96.6167, 3.7638],
      [96.6141, 3.7689],
      [96.6093, 3.7715],
      [96.6055, 3.7769],
      [96.6068, 3.7821],
      [96.6171, 3.7911],
      [96.6169, 3.7949],
      [96.6097, 3.807],
      [96.6102, 3.8126],
      [96.6048, 3.8211],
      [96.5988, 3.8278],
      [96.5829, 3.8385],
      [96.5809, 3.8454],
      [96.5845, 3.8496],
      [96.5879, 3.8566],
      [96.5887, 3.8626],
      [96.5926, 3.8694],
      [96.5921, 3.8759],
      [96.5959, 3.8842],
      [96.594, 3.8906],
      [96.6001, 3.9027],
      [96.6016, 3.9127],
      [96.6049, 3.9154],
      [96.6131, 3.9128],
      [96.6145, 3.9176],
      [96.6171, 3.9189],
      [96.6177, 3.9227],
      [96.6147, 3.9325],
      [96.6214, 3.9352],
      [96.6189, 3.9395],
      [96.6232, 3.9467],
      [96.6258, 3.9478],
      [96.6292, 3.9585],
      [96.635, 3.9603],
      [96.6366, 3.9638],
      [96.6412, 3.9675],
      [96.6448, 3.9675],
      [96.647, 3.9726],
      [96.6512, 3.972],
      [96.6778, 3.9871],
      [96.6841, 3.9844],
      [96.6841, 3.9903],
      [96.6896, 3.991],
      [96.697, 3.9885],
      [96.7101, 4.0063],
      [96.7193, 4.0125],
      [96.7202, 4.0153],
      [96.7171, 4.0216],
      [96.7172, 4.0257],
      [96.7259, 4.0335],
      [96.73, 4.0415],
      [96.7292, 4.0715],
      [96.7252, 4.0817],
      [96.7248, 4.0969],
      [96.734, 4.096],
      [96.7391, 4.0915],
      [96.7471, 4.0943],
      [96.7479, 4.088],
      [96.756, 4.0833],
      [96.7616, 4.0785],
      [96.7628, 4.0755],
      [96.7885, 4.0551],
      [96.7965, 4.0416],
      [96.802, 4.0268],
      [96.803, 3.9976],
      [96.8047, 3.9902],
      [96.8091, 3.9831],
      [96.836, 3.9594],
      [96.8826, 3.9509],
      [96.9625, 3.945],
      [96.9804, 3.9424],
      [96.9939, 3.9467],
      [97.0017, 3.9526],
      [97.0173, 3.9595],
      [97.0428, 3.961],
      [97.0635, 3.9594],
      [97.0686, 3.9584],
      [97.0746, 3.9536],
      [97.0803, 3.9514],
      [97.1002, 3.9481],
      [97.1082, 3.9411],
      [97.117, 3.9286],
      [97.1178, 3.922],
      [97.1157, 3.9116],
      [97.1079, 3.8922],
      [97.1092, 3.8752],
      [97.1135, 3.8642],
      [97.1068, 3.8571],
      [97.1056, 3.8448],
      [97.114, 3.8248],
      [97.1358, 3.7852],
      [97.1536, 3.7456],
      [97.151, 3.7396],
      [97.142, 3.7341],
      [97.1345, 3.694],
      [97.1303, 3.6888],
      [97.1176, 3.6821],
      [97.1073, 3.6741],
      [97.0639, 3.6311],
      [97.0529, 3.6236],
      [97.044, 3.6223],
      [97.0358, 3.6073],
      [97.0326, 3.6046],
      [97.0271, 3.604],
      [97.0137, 3.6092],
      [96.9942, 3.6209],
      [96.9702, 3.623],
      [96.968, 3.6163],
      [96.9659, 3.6151],
      [96.966, 3.6163],
      [96.9629, 3.6129],
      [96.959, 3.6038],
      [96.95, 3.5929],
      [96.9445, 3.583],
      [96.942, 3.5746],
    ];

    await db.insert("regions", {
      "name": "Aceh Barat Daya",
      "polygon": jsonEncode(acehBaratDayaPolygon),
    });

    List<List<double>> acehJayaPolygon = [
      [95.8977, 4.3914],
      [95.8901, 4.3795],
      [95.8802, 4.3724],
      [95.8767, 4.3675],
      [95.78, 4.4726],
      [95.7628, 4.4925],
      [95.765, 4.4939],
      [95.7481, 4.5098],
      [95.7475, 4.5141],
      [95.7415, 4.5159],
      [95.7367, 4.5202],
      [95.7369, 4.5216],
      [95.7181, 4.5359],
      [95.7141, 4.5418],
      [95.7108, 4.542],
      [95.6799, 4.5685],
      [95.6773, 4.5702],
      [95.6752, 4.5675],
      [95.6422, 4.5923],
      [95.6222, 4.6129],
      [95.6033, 4.6278],
      [95.5875, 4.6357],
      [95.5824, 4.6349],
      [95.58, 4.6323],
      [95.5818, 4.6307],
      [95.5813, 4.6273],
      [95.5768, 4.6284],
      [95.5734, 4.6314],
      [95.5677, 4.6305],
      [95.5679, 4.6331],
      [95.5658, 4.6363],
      [95.5695, 4.6376],
      [95.5718, 4.6361],
      [95.5754, 4.6388],
      [95.5725, 4.6443],
      [95.5787, 4.6459],
      [95.5811, 4.6449],
      [95.587, 4.6504],
      [95.5846, 4.6498],
      [95.5844, 4.659],
      [95.5801, 4.6623],
      [95.5722, 4.6623],
      [95.568, 4.668],
      [95.562, 4.6694],
      [95.5582, 4.6676],
      [95.5587, 4.6641],
      [95.5561, 4.6615],
      [95.5575, 4.6579],
      [95.5514, 4.6563],
      [95.5436, 4.6593],
      [95.5397, 4.656],
      [95.5385, 4.6587],
      [95.5406, 4.6634],
      [95.539, 4.6679],
      [95.5421, 4.6716],
      [95.5406, 4.6739],
      [95.5361, 4.6742],
      [95.5343, 4.6724],
      [95.5324, 4.6788],
      [95.5329, 4.6836],
      [95.5295, 4.6895],
      [95.5228, 4.697],
      [95.5103, 4.7064],
      [95.5078, 4.7056],
      [95.5043, 4.7109],
      [95.5069, 4.7129],
      [95.5104, 4.7103],
      [95.5122, 4.7113],
      [95.5137, 4.7136],
      [95.5132, 4.719],
      [95.5061, 4.7301],
      [95.4995, 4.7371],
      [95.4964, 4.7373],
      [95.4977, 4.7435],
      [95.4873, 4.7566],
      [95.473, 4.7703],
      [95.4634, 4.7779],
      [95.4519, 4.7837],
      [95.454, 4.7865],
      [95.454, 4.7898],
      [95.4518, 4.7994],
      [95.4469, 4.8068],
      [95.443, 4.809],
      [95.4369, 4.8074],
      [95.4275, 4.8095],
      [95.4236, 4.8177],
      [95.4132, 4.8205],
      [95.4132, 4.8255],
      [95.4173, 4.8242],
      [95.4249, 4.8271],
      [95.4263, 4.8363],
      [95.4178, 4.8549],
      [95.4111, 4.8578],
      [95.3982, 4.8717],
      [95.3964, 4.877],
      [95.3995, 4.8827],
      [95.4024, 4.8942],
      [95.3928, 4.9024],
      [95.3898, 4.9148],
      [95.3865, 4.9204],
      [95.3783, 4.9208],
      [95.3759, 4.9327],
      [95.3715, 4.9388],
      [95.3688, 4.949],
      [95.375, 4.9535],
      [95.3771, 4.9592],
      [95.3808, 4.9617],
      [95.3812, 4.9707],
      [95.3741, 4.9758],
      [95.3747, 4.983],
      [95.3703, 4.9872],
      [95.3683, 4.9974],
      [95.3646, 5.0002],
      [95.3622, 4.9976],
      [95.3593, 4.9976],
      [95.3557, 5.004],
      [95.3554, 5.0066],
      [95.3585, 5.0084],
      [95.3547, 5.0128],
      [95.3621, 5.0113],
      [95.3672, 5.0136],
      [95.3686, 5.0222],
      [95.3666, 5.0322],
      [95.3624, 5.0388],
      [95.3583, 5.0395],
      [95.3569, 5.038],
      [95.3534, 5.0435],
      [95.345, 5.0498],
      [95.3396, 5.0515],
      [95.3363, 5.0487],
      [95.3328, 5.0501],
      [95.3303, 5.0592],
      [95.3252, 5.0678],
      [95.3233, 5.0691],
      [95.3202, 5.0683],
      [95.3211, 5.0727],
      [95.3182, 5.0751],
      [95.3185, 5.0776],
      [95.3164, 5.079],
      [95.3127, 5.078],
      [95.306, 5.0812],
      [95.3104, 5.082],
      [95.3164, 5.0806],
      [95.3195, 5.0846],
      [95.3206, 5.0908],
      [95.3195, 5.0934],
      [95.3158, 5.0936],
      [95.3134, 5.0977],
      [95.3108, 5.0979],
      [95.3122, 5.1019],
      [95.3082, 5.107],
      [95.3041, 5.1091],
      [95.3036, 5.1151],
      [95.2993, 5.1164],
      [95.2918, 5.1096],
      [95.2893, 5.1104],
      [95.2827, 5.1084],
      [95.2844, 5.1115],
      [95.2834, 5.1144],
      [95.2814, 5.115],
      [95.2866, 5.1193],
      [95.2898, 5.1205],
      [95.2988, 5.1193],
      [95.3038, 5.125],
      [95.3057, 5.1238],
      [95.3107, 5.1291],
      [95.3097, 5.1314],
      [95.3065, 5.1319],
      [95.3014, 5.139],
      [95.305, 5.1394],
      [95.3071, 5.1466],
      [95.3059, 5.15],
      [95.3087, 5.1621],
      [95.3063, 5.1672],
      [95.3085, 5.1664],
      [95.3129, 5.1705],
      [95.3195, 5.1727],
      [95.324, 5.1787],
      [95.3328, 5.1811],
      [95.3328, 5.1829],
      [95.3288, 5.1863],
      [95.3295, 5.1891],
      [95.3342, 5.1926],
      [95.3302, 5.1979],
      [95.332, 5.1997],
      [95.3303, 5.2048],
      [95.332, 5.2086],
      [95.3271, 5.2148],
      [95.3267, 5.2192],
      [95.3222, 5.2241],
      [95.3255, 5.2312],
      [95.3313, 5.234],
      [95.3414, 5.2345],
      [95.3479, 5.2396],
      [95.3472, 5.2451],
      [95.3534, 5.2463],
      [95.3631, 5.2532],
      [95.3675, 5.2541],
      [95.3749, 5.2504],
      [95.3772, 5.2469],
      [95.3791, 5.2381],
      [95.3868, 5.2339],
      [95.387, 5.2293],
      [95.3923, 5.2269],
      [95.3912, 5.2196],
      [95.3952, 5.2168],
      [95.3982, 5.2183],
      [95.3998, 5.2169],
      [95.4019, 5.2145],
      [95.4019, 5.2104],
      [95.4123, 5.2163],
      [95.4175, 5.2216],
      [95.427, 5.2208],
      [95.4352, 5.2239],
      [95.4391, 5.2191],
      [95.4508, 5.2188],
      [95.4599, 5.2153],
      [95.4624, 5.2126],
      [95.467, 5.2117],
      [95.4694, 5.2137],
      [95.4753, 5.2099],
      [95.4861, 5.2115],
      [95.493, 5.2179],
      [95.4997, 5.2202],
      [95.516, 5.216],
      [95.5375, 5.2156],
      [95.5482, 5.2061],
      [95.5819, 5.2092],
      [95.59, 5.2049],
      [95.5971, 5.1925],
      [95.6093, 5.1912],
      [95.6161, 5.1886],
      [95.6197, 5.1819],
      [95.6239, 5.1674],
      [95.6441, 5.141],
      [95.6353, 5.1315],
      [95.6297, 5.1101],
      [95.6303, 5.0917],
      [95.6344, 5.0807],
      [95.6395, 5.0737],
      [95.6508, 5.0665],
      [95.6734, 5.061],
      [95.6961, 5.059],
      [95.7054, 5.0526],
      [95.7205, 5.0555],
      [95.7336, 5.0535],
      [95.7432, 5.0612],
      [95.7624, 5.0557],
      [95.7664, 5.038],
      [95.7725, 5.0274],
      [95.7785, 5.0223],
      [95.7839, 5.009],
      [95.7964, 5.0017],
      [95.803, 4.9884],
      [95.8228, 4.9742],
      [95.8479, 4.9512],
      [95.8517, 4.9447],
      [95.8552, 4.9295],
      [95.8791, 4.9149],
      [95.8823, 4.909],
      [95.8859, 4.8939],
      [95.9018, 4.8664],
      [95.9224, 4.8485],
      [95.9558, 4.8313],
      [95.9613, 4.82],
      [95.9717, 4.81],
      [95.9788, 4.7964],
      [95.9912, 4.7866],
      [95.9932, 4.7827],
      [95.9954, 4.7675],
      [95.9948, 4.7564],
      [95.997, 4.752],
      [96.0048, 4.7465],
      [96.0082, 4.7413],
      [96.0281, 4.694],
      [96.0315, 4.6836],
      [96.0324, 4.6693],
      [96.0424, 4.6576],
      [96.0337, 4.6422],
      [96.0325, 4.6281],
      [96.0277, 4.6165],
      [96.0374, 4.6009],
      [96.0463, 4.5973],
      [96.0511, 4.5909],
      [96.0506, 4.5837],
      [96.0479, 4.5832],
      [96.0467, 4.5798],
      [96.047, 4.5668],
      [96.0367, 4.5624],
      [96.0279, 4.5625],
      [96.0249, 4.5608],
      [96.0057, 4.5462],
      [96.0, 4.5392],
      [95.9885, 4.5363],
      [95.9648, 4.5177],
      [95.9537, 4.5033],
      [95.9352, 4.4657],
      [95.9278, 4.4447],
      [95.9189, 4.4328],
      [95.9144, 4.4148],
      [95.8977, 4.3914],
    ];

    await db.insert("regions", {
      "name": "Aceh Jaya",
      "polygon": jsonEncode(acehJayaPolygon),
    });

    // ------------------ PROJECTS TABLE ------------------
    await db.execute('''
      CREATE TABLE projects (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_id TEXT,
        nama_project TEXT,
        keterangan TEXT,
        is_sync INTEGER DEFAULT 0,
        is_delete INTEGER DEFAULT 0
      )
    ''');

    // ------------------ PROJECT SEEDER ------------------
    await db.insert("projects", {
      "project_id": "PRJ-001",
      "nama_project": "Proyek Sample 1",
      "keterangan": "Contoh proyek awal",
      "is_sync": 0,
      "is_delete": 0,
    });
  }

  Future<bool> login(String username, String password) async {
    final db = await instance.database;
    final result = await db.query(
      "users",
      where: "username = ? AND password = ?",
      whereArgs: [username, password],
    );

    return result.isNotEmpty;
  }

  Future<List<Map<String, dynamic>>> getProjects() async {
    final db = await instance.database;

    return await db.query(
      "projects",
      where: "is_delete = 0",
      orderBy: "id DESC",
    );
  }

  Future<int> insertProject({
    required String projectId,
    required String namaProject,
    String? keterangan,
    int isSync = 0,
    int isDelete = 0,
  }) async {
    final db = await instance.database;

    return await db.insert("projects", {
      "project_id": projectId,
      "nama_project": namaProject,
      "keterangan": keterangan ?? "",
      "is_sync": isSync,
      "is_delete": isDelete,
    });
  }
}
